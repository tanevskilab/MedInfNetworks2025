---
title: "TCGA Data Visualization"
editor: visual
format:
  html:
    toc: true
    toc-location: left
    toc-title: "Contents"
    toc-depth: 4
    sidebar: floating
---

## Loading the BRCA Dataset for Visualization

In this notebook, we will explore and visualize RNA-seq data from TCGA-BRCA that we previously downloaded and prepared. Before creating plots, we need to load the required R packages and the prepared dataset.

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(SummarizedExperiment)
```

```{r}
brca_data_small <- readRDS("brca_data_small.rds")
```

::: {.callout-tip title="Exercise"}
Do you remember how to access the three components of the SummarizedExperiment object? Create an `expr_matrix`, `sample_metadata`, and `feature_metadata`.
:::

```{r}
#| code-fold: true
expr_matrix <- assay(brca_data_small)        
sample_metadata <- colData(brca_data_small)  
feature_metadata <- rowData(brca_data_small) 
```

## Visualization of the SummarizedExperiment Object

### Exploring Pathologic Stage in the BRCA Dataset

We can start by visualizing the distribution of pathologic stages in our selected BRCA samples. The "paper_pathologic_stage" column in the sample metadata contains this information for tumor samples, whereas normal tissue samples will have NA for this field.

```{r}

ggplot(as.data.frame(sample_metadata), 
       aes(x = paper_pathologic_stage)) +
  geom_bar() +
  theme_bw() +
  labs(
    title = "Pathologic Stage Frequency",
    x = "Pathologic Stage",
    y = "Count"
  )
```

We can also compare tumor and normal samples to see how stage information relates to tissue type. By coloring the bars by "tissue_type", we can immediately identify which bars represent tumors and which represent normal samples:

```{r}

ggplot(as.data.frame(sample_metadata), 
       aes(x = paper_pathologic_stage, fill = tissue_type)) +
  geom_bar() +
  theme_bw() +
  labs(
    title = "Pathologic Stage Frequency",
    x = "Pathologic Stage",
    y = "Count"
  )
```

Tumor samples will have stage information, while normal tissue are assigned to NA

::: {.callout-tip title="Exercise"}
What happens when you plot "ajcc_pathologic_stage" as the x-axis and color after "tissue_type"? Does the result make sense?
:::

<details>

<summary>Show Plot</summary>

```{r}
#| code-fold: true
ggplot(as.data.frame(sample_metadata), 
       aes(x = ajcc_pathologic_stage, fill = tissue_type)) +
  geom_bar() +
  theme_bw() +
  labs(
    title = "Pathologic Stage Frequency",
    x = "Pathologic Stage",
    y = "Frequency"
  )

```

Notice that normal (healthy) tissue samples have a pathologic stage assigned. This likely reflects metadata inheritance from the donor and does not represent an actual tumor stage. Always carefully check metadata before using it for analysis."

</details>

### Basic Expression Statistics

Next, we examine basic statistics of the log-transformed expression data to get a sense of sample distributions.

```{r}
logdata <- log2(expr_matrix + 1)

c_mean <- colMeans(logdata)
c_median <- apply(logdata, 2, median)
c_std <- apply(logdata, 2, sd)

rng <- 1:length(c_mean)

sumstats <- data.frame(
c_mean = c_mean,
c_median = c_median,
c_std = c_std,
rng = rng
)

statplot <- ggplot(sumstats, aes(x = rng, y = c_median)) +
geom_point(aes(color = "median")) +
geom_point(aes(x = rng, y = c_mean, color = "mean")) +
ylim(range(c(c_mean - c_std, c_mean + c_std))) +
ylab("log2(expr + 1)") +
xlab("Sample index") +
theme_bw() +
labs(color = "Statistic")
```

```{r}
statplot
```

This plot shows the mean and median expression for each sample. It provides a quick overview of sample-level expression variation.

### Expression Boxplots by Tissue Type

We convert the expression matrix to a long format for plotting:

```{r}
long.data <- logdata %>%
  as.data.frame() %>%
  rownames_to_column(var = "gene") %>%
  pivot_longer(-gene, names_to = "sample", values_to = "expr")

# Add tissue information from sample metadata
long.data <- long.data %>%
  left_join(as.data.frame(sample_metadata) %>%
              select(-sample) %>%
              rownames_to_column(var = "sample") %>%
              select(sample, sample_type),
            by = "sample") %>%
  arrange(sample_type, sample) %>%  # order rows
  mutate(sample_ordered = factor(sample, levels = unique(sample)))  # factor for plotting

```

```{r}
ggplot(long.data, aes(x = sample_ordered, y = expr, fill = sample_type)) +
  geom_boxplot() +
  theme_bw() +
  labs(x = "Sample", y = "log2(expr + 1)", fill = "Tissue Type",
       title = "Expression Distribution per Sample") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

Each boxplot shows the distribution of log2-transformed expression values for each sample. Coloring by sample_type allows us to visually compare tumor and normal samples.

### Expression Distribution: Histograms and Density Plots

We can inspect the expression distribution for individual samples using histograms and density plots.

```{r}
# Select one sample to visualize
sample_name <- long.data$sample[1]  # pick first sample, or specify your own
data_sample_name <- long.data %>% filter(sample == sample_name)

# Histogram + density for a single sample
ggplot(data_sample_name, aes(x = expr)) +
  geom_histogram(aes(y = ..density..), color = "black", fill = "grey", bins = 50) +
  geom_density(alpha = 0.2, fill = "#FF6666") +
  theme_bw() +
  labs(title = paste("Expression Distribution:", sample_name),
       x = "log2(expr + 1)",
       y = "Density")
```

We can also visualize multiple samples together using facet_wrap:

```{r}
# Now do the same for a small subset of samples (e.g., first 4 samples)
sample_name <- unique(long.data$sample)[1:4]
data_sample_name <- long.data %>% filter(sample %in% sample_name)

# Histogram + density faceted by sample
ggplot(data_sample_name, aes(x = expr)) +
  geom_histogram(aes(y = ..density..), color = "black", fill = "grey", bins = 50) +
  geom_density(alpha = 0.2, fill = "#FF6666") +
  facet_wrap(~sample) +
  theme_bw() +
  labs(title = "Expression Distribution Across Selected Samples",
       x = "log2(expr + 1)",
       y = "Density")
```

The histograms reveal that many genes have zero counts (spike at 0), followed by a gap and a long tail of higher expressed genes.
